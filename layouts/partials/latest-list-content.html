<section class="ph2 pv4 ph4-ns pv5-ns bg-white">
  <h1 class="f6 f5-ns fw6 mb4 black-90" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em;">{{ if eq .Language.Lang "de" }}NEUESTE{{ else }}LATEST NEWS{{ end }}</h1>
  <div class="news-list">
    {{/* Get latest news pages for current language */}}
    {{ $currentLang := .Site.Language.Lang }}
    {{/* Also check page language as fallback */}}
    {{ if not $currentLang }}
      {{ $currentLang = .Language.Lang }}
    {{ end }}
    {{/* If still not set, check URL path */}}
    {{ if not $currentLang }}
      {{ if hasPrefix .RelPermalink "/de/" }}
        {{ $currentLang = "de" }}
      {{ else }}
        {{ $currentLang = "en" }}
      {{ end }}
    {{ end }}
    
    {{ $latestNews := slice }}
    
    {{/* Get latest section and filter pages by current language, excluding drafts */}}
    {{ $latestSection := .Site.GetPage "section" "latest" }}
    {{ if $latestSection }}
      {{ range $latestSection.Pages }}
        {{ $pageLang := .Lang }}
        {{ if not $pageLang }}
          {{ if and .File (hasSuffix .File.LogicalName ".de.md") }}
            {{ $pageLang = "de" }}
          {{ else if and .File (hasSuffix .File.LogicalName ".en.md") }}
            {{ $pageLang = "en" }}
          {{ end }}
        {{ end }}
        {{ $isDraft := false }}
        {{ if .Draft }}
          {{ $isDraft = true }}
        {{ else if isset .Params "draft" }}
          {{ if .Params.draft }}
            {{ $isDraft = true }}
          {{ end }}
        {{ end }}
        {{ if and (eq $pageLang $currentLang) (ne .Kind "section") (not .IsNode) (not $isDraft) }}
          {{ $latestNews = $latestNews | append . }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{/* Fallback: Use AllPages if section pages didn't work */}}
    {{ if not $latestNews }}
      {{ $latestNews = where .Site.AllPages "Section" "latest" }}
      {{ $filteredNews := slice }}
      {{ range $latestNews }}
        {{ $pageLang := .Lang }}
        {{ if not $pageLang }}
          {{ if and .File (hasSuffix .File.LogicalName ".de.md") }}
            {{ $pageLang = "de" }}
          {{ else if and .File (hasSuffix .File.LogicalName ".en.md") }}
            {{ $pageLang = "en" }}
          {{ end }}
        {{ end }}
        {{ $isDraft := false }}
        {{ if .Draft }}
          {{ $isDraft = true }}
        {{ else if isset .Params "draft" }}
          {{ if .Params.draft }}
            {{ $isDraft = true }}
          {{ end }}
        {{ end }}
        {{ if and (eq $pageLang $currentLang) (ne .Kind "section") (not .IsNode) (not $isDraft) }}
          {{ $filteredNews = $filteredNews | append . }}
        {{ end }}
      {{ end }}
      {{ $latestNews = $filteredNews }}
    {{ end }}
    
    {{ $latestNews = $latestNews.ByDate.Reverse }}
    {{ range $latestNews }}
      {{ $newsItem := . }}
      {{/* Get date: exhibition_start_date (preferred), then exhibition_end_date, then date from current file */}}
      {{ $displayDate := "" }}
      {{/* Check exhibition_start_date in current file first - if it exists and is valid, use it */}}
      {{ if isset $newsItem.Params "exhibition_start_date" }}
        {{ if $newsItem.Params.exhibition_start_date }}
          {{ $parsedExhibitionStartDate := time $newsItem.Params.exhibition_start_date }}
          {{/* Only use if successfully parsed (not zero date) */}}
          {{ if and $parsedExhibitionStartDate (not $parsedExhibitionStartDate.IsZero) }}
            {{ $displayDate = $parsedExhibitionStartDate }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{/* If no exhibition_start_date, try exhibition_end_date */}}
      {{ if or (not $displayDate) $displayDate.IsZero }}
        {{ if isset $newsItem.Params "exhibition_end_date" }}
          {{ if $newsItem.Params.exhibition_end_date }}
            {{ $parsedExhibitionEndDate := time $newsItem.Params.exhibition_end_date }}
            {{/* Only use if successfully parsed (not zero date) */}}
            {{ if and $parsedExhibitionEndDate (not $parsedExhibitionEndDate.IsZero) }}
              {{ $displayDate = $parsedExhibitionEndDate }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{/* Legacy support: check old exhibition_date field */}}
      {{ if or (not $displayDate) $displayDate.IsZero }}
        {{ if isset $newsItem.Params "exhibition_date" }}
          {{ if $newsItem.Params.exhibition_date }}
            {{ $parsedExhibitionDate := time $newsItem.Params.exhibition_date }}
            {{/* Only use if successfully parsed (not zero date) */}}
            {{ if and $parsedExhibitionDate (not $parsedExhibitionDate.IsZero) }}
              {{ $displayDate = $parsedExhibitionDate }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{/* If no exhibition dates or they're invalid, use date from current file */}}
      {{ if or (not $displayDate) $displayDate.IsZero }}
        {{ if isset $newsItem.Params "date" }}
          {{ if $newsItem.Params.date }}
            {{ $displayDate = time $newsItem.Params.date }}
          {{ end }}
        {{ end }}
        {{/* Final fallback to Hugo's Date field */}}
        {{ if or (not $displayDate) $displayDate.IsZero }}
          {{ if not $newsItem.Date.IsZero }}
            {{ $displayDate = $newsItem.Date }}
          {{ end }}
        {{ end }}
      {{ end }}
      <a href="{{ $newsItem.RelPermalink }}" class="db no-underline news-item" style="border-bottom: 1px solid #e5e5e5; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
        <div class="flex-auto">
          <h3 class="f6 f5-ns fw4 black-90 mb0" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em; margin: 0;">{{ $newsItem.Title }}</h3>
        </div>
        {{ if and $displayDate (not $displayDate.IsZero) }}
          <div class="ml3 ml4-ns" style="flex-shrink: 0;">
            <span class="f7 f6-ns black-60" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em; white-space: nowrap;">
              {{ $displayDate.Format "2 January 2006" | upper }}
            </span>
          </div>
        {{ end }}
      </a>
    {{ end }}
    {{ if not $latestNews }}
      <p class="f6 f5-ns black-70" style="font-family: 'Inter', sans-serif;">No news items yet.</p>
    {{ end }}
  </div>
</section>

<style>
  .news-item:hover {
    background-color: #fafafa;
  }
  
  /* Stack news items vertically on mobile */
  @media (max-width: 30em) {
    .news-item {
      flex-direction: column !important;
      align-items: flex-start !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }
    .news-item > .flex-auto {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    .news-item .ml3,
    .news-item .ml3.ml4-ns {
      margin-left: 0 !important;
      margin-top: 0 !important;
      width: 100%;
      display: block;
    }
    .news-item h3 {
      display: block;
      width: 100%;
      margin-bottom: 0;
    }
  }
</style>

