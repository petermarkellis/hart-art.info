{{ define "main" }}
<!-- CUSTOM TAXONOMY TEMPLATE -->
<div class="flex flex-column flex-row-l bg-white series-layout-wrapper" style="min-height: 100vh; width: 100%;">
  <!-- Left Sidebar - Series Navigation -->
  <aside class="w-100 w-25-l pa3 pa4-l bg-white dn db-l aside-full-height" style="border-right: 1px solid #e5e5e5;">
    {{ partial "series-navigation.html" . }}
  </aside>

  <!-- Main Content Area -->
  <div class="w-100 w-75-l ph2 pv3 pa4-l bg-white" style="flex: 1; padding-bottom: 4rem !important;">
    <!-- Mobile Series Menu - Only visible on mobile -->
    {{ partial "series-mobile-menu.html" . }}

    {{/* Get the series slug from the taxonomy term */}}
    {{ $seriesSlug := .Data.Term }}
    {{ $seriesPage := false }}
    {{ $lang := .Site.Language.Lang }}
    
    {{/* Get the series page for current language */}}
    {{ $seriesSection := .Site.GetPage "section" "series" }}
    {{ if $seriesSection }}
      {{ range $seriesSection.Pages }}
        {{ if and .Params.series_slug (eq .Params.series_slug $seriesSlug) (eq .Lang $lang) }}
          {{ $seriesPage = . }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{/* Fallback: Try RegularPages if section pages didn't work */}}
    {{ if not $seriesPage }}
      {{ range where .Site.RegularPages "Section" "series" }}
        {{ if and .Params.series_slug (eq .Params.series_slug $seriesSlug) (eq .Lang $lang) }}
          {{ $seriesPage = . }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{/* Final fallback: Try GetPage with path format */}}
    {{ if not $seriesPage }}
      {{ $paths := slice 
        (printf "series/%s.%s" $seriesSlug $lang)
        (printf "series/%s" $seriesSlug)
      }}
      {{ range $paths }}
        {{ if not $seriesPage }}
          {{ $page := $.Site.GetPage . }}
          {{ if and $page (eq $page.Section "series") (eq $page.Lang $lang) }}
            {{ $seriesPage = $page }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{ if $seriesPage }}
      <!-- Series Title -->
      <h1 class="f4 f3-ns fw6 mb4 black-90" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em;">
        {{ $seriesPage.Title | upper }}
      </h1>

      <!-- Series Description -->
      {{ if $seriesPage.Params.description }}
        <div class="f6 f5-ns lh-copy mb5 black-80" style="font-family: 'Inter', sans-serif; max-width: 800px;">
          {{ $seriesPage.Params.description | markdownify }}
        </div>
      {{ end }}

      <!-- Gallery Images -->
      {{ if $seriesPage.Params.gallery_images }}
        <div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem 3rem; margin-bottom: 4rem;">
          {{ range $index, $galleryImage := $seriesPage.Params.gallery_images }}
            <div class="gallery-item">
              {{ if .image }}
                <div class="mb3" style="width: 100%;">
                    {{ $imgAlt := "" }}
                    {{ $currentLang := $.Site.Language.Lang }}
                    {{ if eq $currentLang "de" }}
                      {{ $imgAlt = .title_de | default .title_en | default "Artwork" }}
                    {{ else }}
                      {{ $imgAlt = .title_en | default .title_de | default "Artwork" }}
                    {{ end }}
                    {{/* Fallback to old format for backward compatibility */}}
                    {{ if not $imgAlt }}
                      {{ if reflect.IsMap .title }}
                        {{ $imgAlt = index .title $currentLang | default (index .title "en") | default "Artwork" }}
                      {{ else }}
                        {{ $imgAlt = .title | default "Artwork" }}
                      {{ end }}
                    {{ end }}
                    <img 
                      src="{{ .image }}" 
                      alt="{{ $imgAlt }}" 
                      class="w-100 gallery-image-clickable" 
                      style="max-width: 100%; height: auto; display: block; cursor: pointer;" 
                      onclick="openImageModal({{ $index }}, '{{ $seriesSlug }}')"
                      data-image-index="{{ $index }}"
                      data-image-src="{{ .image }}"
                      data-title-en="{{ .title_en | default "" }}"
                      data-title-de="{{ .title_de | default "" }}"
                      data-medium-en="{{ .medium_en | default "" }}"
                      data-medium-de="{{ .medium_de | default "" }}"
                      data-dimensions="{{ .dimensions | default "" }}"
                      data-year="{{ .year | default "" }}"
                      data-series-slug="{{ $seriesSlug }}"
                      data-series-title="{{ $seriesPage.Title }}"
                    />
                </div>
              {{ end }}
              {{/* Get title in current language */}}
              {{ $title := "" }}
              {{ $currentLang := $.Site.Language.Lang }}
              {{ if eq $currentLang "de" }}
                {{ $title = .title_de | default .title_en | default "" }}
              {{ else }}
                {{ $title = .title_en | default .title_de | default "" }}
              {{ end }}
              {{/* Fallback to old format for backward compatibility */}}
              {{ if not $title }}
                {{ if reflect.IsMap .title }}
                  {{ $title = index .title $currentLang | default (index .title "en") | default "" }}
                {{ else }}
                  {{ $title = .title }}
                {{ end }}
              {{ end }}
              {{ if $title }}
                <div class="f6 f5-ns fw4 black-90 mb1" style="font-family: 'Inter', sans-serif;">
                  <span class="black-90" onclick="openImageModal({{ $index }}, '{{ $seriesSlug }}')" style="cursor: pointer;">
                    {{ $title | upper }}
                  </span>
                </div>
              {{ end }}
              {{/* Get medium in current language */}}
              {{ $medium := "" }}
              {{ if eq $currentLang "de" }}
                {{ $medium = .medium_de | default .medium_en | default "" }}
              {{ else }}
                {{ $medium = .medium_en | default .medium_de | default "" }}
              {{ end }}
              {{/* Fallback to old format for backward compatibility */}}
              {{ if not $medium }}
                {{ if reflect.IsMap .medium }}
                  {{ $medium = index .medium $currentLang | default (index .medium "en") | default "" }}
                {{ else }}
                  {{ $medium = .medium }}
                {{ end }}
              {{ end }}
                {{ if $medium }}
                  {{ $mediumFormatted := strings.FirstUpper $medium }}
                  <div class="f7 f6-ns black-70 mb1" style="font-family: 'Inter', sans-serif;">
                    {{ $mediumFormatted }}
                  </div>
                {{ end }}
              {{/* Get dimensions - show only the one matching current locale */}}
              {{ $dimensionsEn := .dimensions_en | default "" }}
              {{ $dimensionsDe := .dimensions_de | default "" }}
              {{ $dimensionsLegacy := .dimensions | default "" }}
              
              {{ $dimensions := "" }}
              {{ if eq $currentLang "de" }}
                {{ $dimensions = $dimensionsDe | default $dimensionsEn | default $dimensionsLegacy | default "" }}
              {{ else }}
                {{ $dimensions = $dimensionsEn | default $dimensionsDe | default $dimensionsLegacy | default "" }}
              {{ end }}
              
              {{ if $dimensions }}
                <div class="f7 f6-ns black-70 mb1" style="font-family: 'Inter', sans-serif;">
                  {{ $dimensions }}
                </div>
              {{ end }}
              {{ if .year }}
                <div class="f7 f6-ns black-70" style="font-family: 'Inter', sans-serif;">
                  {{ .year }}
                </div>
              {{ end }}
            </div>
          {{ end }}
        </div>
      {{ else }}
        {{/* Fallback: Show artworks from this series if no gallery images */}}
        {{ $artworks := where .Site.RegularPages "Section" "artworks" }}
        {{ $seriesArtworks := slice }}
        {{ range $artworks }}
          {{ $artwork := . }}
          {{ if .Params.series }}
            {{ if reflect.IsSlice .Params.series }}
              {{ range .Params.series }}
                {{ if eq . $seriesSlug }}
                  {{ $seriesArtworks = $seriesArtworks | append $artwork }}
                {{ end }}
              {{ end }}
            {{ else }}
              {{ if eq .Params.series $seriesSlug }}
                {{ $seriesArtworks = $seriesArtworks | append . }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
        
        {{ if $seriesArtworks }}
          <div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem 3rem; margin-bottom: 4rem;">
            {{ range $seriesArtworks }}
              <div class="gallery-item">
                {{ if .Params.image }}
                  <div class="mb3" style="width: 100%;">
                    <a href="{{ .RelPermalink }}" class="db no-underline">
                      <img src="{{ .Params.image }}" alt="{{ .Title }}" class="w-100" style="max-width: 100%; height: auto; display: block;" />
                    </a>
                  </div>
                {{ end }}
                <div class="f6 f5-ns fw4 black-90 mb1" style="font-family: 'Inter', sans-serif;">
                  <a href="{{ .RelPermalink }}" class="black-90 hover-black no-underline">
                    {{ .Title }}
                  </a>
                </div>
                {{ if or .Params.medium .Params.dimensions }}
                  <div class="f7 f6-ns black-70" style="font-family: 'Inter', sans-serif;">
                    {{ if .Params.medium }}{{ .Params.medium }}{{ end }}{{ if and .Params.medium .Params.dimensions }}, {{ end }}{{ if .Params.dimensions }}{{ .Params.dimensions }}{{ end }}
                  </div>
                {{ end }}
              </div>
            {{ end }}
          </div>
        {{ end }}
      {{ end }}
    {{ else }}
      <div class="f6 f5-ns black-80" style="font-family: 'Inter', sans-serif;">
        Series content not found.
      </div>
    {{ end }}
    <div class="pb6"></div>
  </div>
</div>

<style>
  /* Hover underline for navigation links */
  .series-nav-link:hover {
    text-decoration: underline !important;
  }
  
  @media (max-width: 60em) {
    .series-nav {
      margin-bottom: 2rem;
    }
    .series-nav ul {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .series-nav li {
      margin-bottom: 0;
    }
    
    .gallery-grid {
      grid-template-columns: 1fr !important;
    }
  }
</style>

{{ partial "image-modal.html" . }}
{{ end }}

