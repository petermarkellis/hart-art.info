
{{ define "head" }}
  <style>
    .hero-banner {
      position: relative;
    }
    
    .aspect-ratio {
      position: relative;
      height: 0;
      overflow: hidden;
    }
    
    .aspect-ratio--1x1 {
      padding-bottom: 100%;
    }
    
    .aspect-ratio--object {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 100;
      object-fit: cover;
    }
    
    /* Responsive quote box */
    @media (max-width: 60em) {
      .hero-banner .absolute {
        position: relative;
        margin: 1rem;
        max-width: 100% !important;
      }
    }
    
    /* News item hover */
    .news-item:hover {
      background-color: #fafafa;
    }
    
    /* Stack news items vertically on mobile */
    @media (max-width: 30em) {
      .news-item {
        flex-direction: column !important;
        align-items: flex-start !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
      .news-item > .flex-auto {
        width: 100%;
        margin-bottom: 0.5rem;
      }
      .news-item .ml3,
      .news-item .ml3.ml4-ns {
        margin-left: 0 !important;
        margin-top: 0 !important;
        width: 100%;
        display: block;
      }
      .news-item h3 {
        display: block;
        width: 100%;
        margin-bottom: 0;
      }
    }
  </style>
{{ end }}

{{ define "main" }}
  {{/* Get homepage content */}}
  {{ $homepagePage := false }}
  {{ $lang := .Site.Language.Lang }}
  
  {{/* Get homepage section and find the page for current language */}}
  {{ $homepageSection := .Site.GetPage "section" "homepage" }}
  {{ if $homepageSection }}
    {{/* First try to find language-specific page */}}
    {{ range $homepageSection.Pages }}
      {{ if and (not $homepagePage) (eq .Lang $lang) }}
        {{ $homepagePage = . }}
      {{ end }}
    {{ end }}
    {{/* Fallback: if no language-specific page found, use base index.md (which has hero_images) */}}
    {{ if not $homepagePage }}
      {{ range $homepageSection.Pages }}
        {{ if not $homepagePage }}
          {{ $homepagePage = . }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{/* If still no page, try to get the base index.md file directly */}}
    {{ if not $homepagePage }}
      {{ $baseIndex := $homepageSection.GetPage "index.md" }}
      {{ if $baseIndex }}
        {{ $homepagePage = $baseIndex }}
      {{ end }}
    {{ end }}
  {{ end }}
  
  {{/* Default values if homepage page not found */}}
  {{ $heroImages := slice "/images/uploads/hero.webp" }}
  {{ $quoteText := "THE SUBCONSCIOUS DICTATES!" }}
  {{ $quoteAuthor := "ANDRÃ‰ MASSON" }}
  {{ $showLatestNews := true }}
  {{ $showQuote := true }}
  
  {{ if $homepagePage }}
    {{/* Check for multiple hero images first, then fallback to single image */}}
    {{ if $homepagePage.Params.hero_images }}
      {{/* Ensure hero_images is treated as a slice/array */}}
      {{ $heroImagesRaw := $homepagePage.Params.hero_images }}
      {{ if reflect.IsSlice $heroImagesRaw }}
        {{ $heroImages = $heroImagesRaw }}
      {{ else }}
        {{ $heroImages = slice $heroImagesRaw }}
      {{ end }}
    {{ else }}
      {{/* If language-specific page doesn't have hero_images, check base index.md */}}
      {{ if $homepageSection }}
        {{ $baseIndex := $homepageSection.GetPage "index.md" }}
        {{ if and $baseIndex $baseIndex.Params.hero_images }}
          {{ $heroImages = $baseIndex.Params.hero_images }}
        {{ end }}
      {{ end }}
      {{/* Final fallback: use single hero_image */}}
      {{ if and (not $heroImages) $homepagePage.Params.hero_image }}
        {{ $heroImages = slice $homepagePage.Params.hero_image }}
      {{ end }}
    {{ end }}
    {{ if $homepagePage.Params.quote_text }}
      {{ $quoteText = $homepagePage.Params.quote_text }}
    {{ end }}
    {{ if $homepagePage.Params.quote_author }}
      {{ $quoteAuthor = $homepagePage.Params.quote_author }}
    {{ end }}
    {{ if isset $homepagePage.Params "show_latest_news" }}
      {{ $showLatestNews = $homepagePage.Params.show_latest_news }}
    {{ end }}
    {{ if isset $homepagePage.Params "show_quote" }}
      {{ $showQuote = $homepagePage.Params.show_quote }}
    {{ end }}
  {{ end }}

  <!-- Hero Banner Section -->
  <section class="hero-banner relative" style="min-height: 80vh; position: relative; overflow: hidden;">
    <div class="hero-slideshow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
      {{ if $heroImages }}
        {{ range $index, $imageItem := $heroImages }}
          {{ $imagePath := $imageItem.image | default "" }}
          {{ if $imagePath }}
          <div class="hero-slide {{ if eq $index 0 }}active{{ end }}" 
               data-slide-index="{{ $index }}"
               style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('{{ $imagePath }}'); background-size: cover; background-position: center; opacity: {{ if eq $index 0 }}1{{ else }}0{{ end }}; transition: opacity 1s ease-in-out; z-index: 1;">
          </div>
          {{ end }}
        {{ end }}
      {{ end }}
    </div>
    {{ if and $showQuote (or $quoteText $quoteAuthor) }}
    <div class="absolute bottom-0 right-0 ma4 ma5-ns" style="max-width: 400px; z-index: 10;">
      <div class="bg-white" style="padding: 0.6rem 0.8rem;">
        {{ if $quoteText }}
        <p class="f6 f5-ns fw6 mb1 black-90" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em; margin: 0;">"{{ $quoteText }}"</p>
        {{ end }}
        {{ if $quoteAuthor }}
        <p class="f6 f5-ns mb0 black-70" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em; margin: 0;">{{ $quoteAuthor }}</p>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </section>

  {{ if $showLatestNews }}
  <!-- Latest News Section -->
  <section class="ph2 pv4 ph4-ns pv5-ns bg-white">
    <h2 class="f6 f5-ns fw6 mb4 black-90" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em;">{{ if eq .Language.Lang "de" }}NEUESTE{{ else }}LATEST NEWS{{ end }}</h2>
    <div class="news-list">
      {{/* Get latest news pages for current language */}}
      {{ $currentLang := .Language.Lang }}
      {{ $latestNews := slice }}
      
      {{/* Get latest section and filter pages by current language, excluding drafts */}}
      {{ $latestSection := .Site.GetPage "section" "latest" }}
      {{ if $latestSection }}
        {{ range $latestSection.Pages }}
          {{ $isDraft := false }}
          {{ if .Draft }}
            {{ $isDraft = true }}
          {{ else if isset .Params "draft" }}
            {{ if .Params.draft }}
              {{ $isDraft = true }}
            {{ end }}
          {{ end }}
          {{ if and (eq .Lang $currentLang) (ne .Kind "section") (not .IsNode) (not $isDraft) }}
            {{ $latestNews = $latestNews | append . }}
          {{ end }}
        {{ end }}
      {{ end }}
      
      {{/* Fallback: Use AllPages if section pages didn't work */}}
      {{ if not $latestNews }}
        {{ $latestNews = where .Site.AllPages "Section" "latest" }}
        {{ $latestNews = where $latestNews "Lang" $currentLang }}
        {{ $latestNews = where $latestNews "IsNode" false }}
        {{ $latestNews = where $latestNews "Kind" "!=" "section" }}
        {{/* Filter out drafts */}}
        {{ $filteredNews := slice }}
        {{ range $latestNews }}
          {{ $isDraft := false }}
          {{ if .Draft }}
            {{ $isDraft = true }}
          {{ else if isset .Params "draft" }}
            {{ if .Params.draft }}
              {{ $isDraft = true }}
            {{ end }}
          {{ end }}
          {{ if not $isDraft }}
            {{ $filteredNews = $filteredNews | append . }}
          {{ end }}
        {{ end }}
        {{ $latestNews = $filteredNews }}
      {{ end }}
      
      {{/* Sort by date (newest first) and limit to 10 */}}
      {{ if $latestNews }}
        {{/* Convert to proper page collection and sort by date */}}
        {{ $latestNews = $latestNews.ByDate.Reverse | first 10 }}
      {{ else }}
        {{ $latestNews = slice }}
      {{ end }}
      {{ range $latestNews }}
        {{ $newsItem := . }}
        {{/* Get date: exhibition_start_date (preferred), then exhibition_end_date, then date from current file */}}
        {{ $displayDate := "" }}
        {{/* Check exhibition_start_date in current file first - if it exists and is valid, use it */}}
        {{ if isset $newsItem.Params "exhibition_start_date" }}
          {{ if $newsItem.Params.exhibition_start_date }}
            {{ $parsedExhibitionStartDate := time $newsItem.Params.exhibition_start_date }}
            {{/* Only use if successfully parsed (not zero date) */}}
            {{ if and $parsedExhibitionStartDate (not $parsedExhibitionStartDate.IsZero) }}
              {{ $displayDate = $parsedExhibitionStartDate }}
            {{ end }}
          {{ end }}
        {{ end }}
        {{/* If no exhibition_start_date, try exhibition_end_date */}}
        {{ if or (not $displayDate) $displayDate.IsZero }}
          {{ if isset $newsItem.Params "exhibition_end_date" }}
            {{ if $newsItem.Params.exhibition_end_date }}
              {{ $parsedExhibitionEndDate := time $newsItem.Params.exhibition_end_date }}
              {{/* Only use if successfully parsed (not zero date) */}}
              {{ if and $parsedExhibitionEndDate (not $parsedExhibitionEndDate.IsZero) }}
                {{ $displayDate = $parsedExhibitionEndDate }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
        {{/* Legacy support: check old exhibition_date field */}}
        {{ if or (not $displayDate) $displayDate.IsZero }}
          {{ if isset $newsItem.Params "exhibition_date" }}
            {{ if $newsItem.Params.exhibition_date }}
              {{ $parsedExhibitionDate := time $newsItem.Params.exhibition_date }}
              {{/* Only use if successfully parsed (not zero date) */}}
              {{ if and $parsedExhibitionDate (not $parsedExhibitionDate.IsZero) }}
                {{ $displayDate = $parsedExhibitionDate }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
        {{/* If no exhibition dates or they're invalid, use date from current file */}}
        {{ if or (not $displayDate) $displayDate.IsZero }}
          {{ if isset $newsItem.Params "date" }}
            {{ if $newsItem.Params.date }}
              {{ $displayDate = time $newsItem.Params.date }}
            {{ end }}
          {{ end }}
          {{/* Final fallback to Hugo's Date field */}}
          {{ if or (not $displayDate) $displayDate.IsZero }}
            {{ if not $newsItem.Date.IsZero }}
              {{ $displayDate = $newsItem.Date }}
            {{ end }}
          {{ end }}
        {{ end }}
        <a href="{{ .RelPermalink }}" class="db no-underline news-item" style="border-bottom: 1px solid #e5e5e5; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
          <div class="flex-auto">
            <h3 class="f6 f5-ns fw4 black-90 mb0" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em; margin: 0;">{{ .Title }}</h3>
          </div>
          {{ if and $displayDate (not $displayDate.IsZero) }}
            <div class="ml3 ml4-ns" style="flex-shrink: 0;">
              <span class="f7 f6-ns black-60" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em; white-space: nowrap;">
                {{ $displayDate.Format "2 January 2006" | upper }}
              </span>
            </div>
          {{ end }}
        </a>
      {{ end }}
      {{ if not $latestNews }}
        <p class="f6 f5-ns black-70" style="font-family: 'Inter', sans-serif;">No news items yet.</p>
      {{ end }}
    </div>
  </section>
  {{ end }}

  {{/* Hero Slideshow JavaScript */}}
  <script>
    (function() {
      const slides = document.querySelectorAll('.hero-slide');
      if (slides.length <= 1) return; // No slideshow needed if only one image
      
      let currentSlide = 0;
      const slideInterval = 5000; // 5 seconds
      
      function nextSlide() {
        // Fade out current slide
        if (slides[currentSlide]) {
          slides[currentSlide].classList.remove('active');
          slides[currentSlide].style.opacity = '0';
        }
        
        // Move to next slide
        currentSlide = (currentSlide + 1) % slides.length;
        
        // Fade in next slide
        if (slides[currentSlide]) {
          slides[currentSlide].classList.add('active');
          slides[currentSlide].style.opacity = '1';
        }
      }
      
      // Start slideshow after a short delay to ensure images are loaded
      setTimeout(function() {
        setInterval(nextSlide, slideInterval);
      }, 1000);
    })();
  </script>
{{ end }}

