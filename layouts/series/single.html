{{ define "main" }}
<div class="flex flex-column flex-row-l bg-white" style="min-height: 100vh; height: 100%; width: 100%;">
  <!-- Left Sidebar - Series Navigation -->
  <aside class="w-100 w-25-l pa3 pa4-l bg-white dn db-l" style="border-right: 1px solid #e5e5e5; min-height: 100vh; position: sticky; top: 0; align-self: flex-start;">
    {{ partial "series-navigation.html" . }}
  </aside>

  <!-- Main Content Area -->
  <main class="w-100 w-75-l pa3 pa4-l bg-white" style="flex: 1; padding-bottom: 4rem !important;">
    <!-- Mobile Series Menu - Only visible on mobile -->
    {{ partial "series-mobile-menu.html" . }}

    <!-- Series Title -->
    <h1 class="f4 f3-ns fw6 mb4 black-90" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em;">
      {{ .Title | upper }}
    </h1>

    <!-- Series Description -->
    {{ if .Params.description }}
      <div class="f6 f5-ns lh-copy mb5 black-80" style="font-family: 'Inter', sans-serif; max-width: 800px;">
        {{ .Params.description | markdownify }}
      </div>
    {{ end }}

    <!-- Gallery Images -->
    {{ $galleryImages := .Params.gallery_images }}
    {{ $otherLangPage := false }}
    {{ $seriesSlug := .Params.series_slug }}
    {{ $currentLang := .Site.Language.Lang }}
    {{ $otherLang := "en" }}
    {{ if eq $currentLang "en" }}
      {{ $otherLang = "de" }}
    {{ end }}
    
    {{/* Get the other language version of this series page for translations */}}
    {{ range where .Site.AllPages "Section" "series" }}
      {{ if and .Params.series_slug (eq .Params.series_slug $seriesSlug) (eq .Lang $otherLang) }}
        {{ $otherLangPage = . }}
      {{ end }}
    {{ end }}
    
    {{/* If current language has no gallery images, try to get from the other language version */}}
    {{ if not $galleryImages }}
      {{ if and $otherLangPage $otherLangPage.Params.gallery_images }}
        {{ $galleryImages = $otherLangPage.Params.gallery_images }}
      {{ end }}
    {{ end }}
    
    {{ if $galleryImages }}
      <div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem 3rem; margin-bottom: 4rem;">
        {{ range $index, $galleryImage := $galleryImages }}
          {{/* Try to find matching image in current language page for translations */}}
          {{ $currentLangImage := $galleryImage }}
          {{ if and $otherLangPage $otherLangPage.Params.gallery_images }}
            {{ range $otherLangPage.Params.gallery_images }}
              {{ if and .image (eq .image $galleryImage.image) }}
                {{/* Found matching image in current language page - use it for translations */}}
                {{ $currentLangImage = . }}
              {{ end }}
            {{ end }}
          {{ end }}
          <div class="gallery-item">
            {{ if $galleryImage.image }}
              <div class="mb3" style="width: 100%;">
                  {{ $imgAlt := "" }}
                  {{ if eq $currentLang "de" }}
                    {{ $imgAlt = $currentLangImage.title_de | default $currentLangImage.title_en | default $galleryImage.title_de | default $galleryImage.title_en | default "Artwork" }}
                  {{ else }}
                    {{ $imgAlt = $currentLangImage.title_en | default $currentLangImage.title_de | default $galleryImage.title_en | default $galleryImage.title_de | default "Artwork" }}
                  {{ end }}
                  {{/* Fallback to old format for backward compatibility */}}
                  {{ if not $imgAlt }}
                    {{ if reflect.IsMap $currentLangImage.title }}
                      {{ $imgAlt = index $currentLangImage.title $currentLang | default (index $currentLangImage.title "en") | default "Artwork" }}
                    {{ else if reflect.IsMap $galleryImage.title }}
                      {{ $imgAlt = index $galleryImage.title $currentLang | default (index $galleryImage.title "en") | default "Artwork" }}
                    {{ else }}
                      {{ $imgAlt = $currentLangImage.title | default $galleryImage.title | default "Artwork" }}
                    {{ end }}
                  {{ end }}
                  {{ $titleEn := $currentLangImage.title_en | default $galleryImage.title_en | default "" }}
                  {{ $titleDe := $currentLangImage.title_de | default $galleryImage.title_de | default "" }}
                  {{ $mediumEn := $currentLangImage.medium_en | default $galleryImage.medium_en | default "" }}
                  {{ $mediumDe := $currentLangImage.medium_de | default $galleryImage.medium_de | default "" }}
                  {{ $dimensions := $currentLangImage.dimensions | default $galleryImage.dimensions | default "" }}
                  {{ $year := $currentLangImage.year | default $galleryImage.year | default "" }}
                  <img 
                    src="{{ $galleryImage.image }}" 
                    alt="{{ $imgAlt }}" 
                    class="w-100 gallery-image-clickable" 
                    style="max-width: 100%; height: auto; display: block; cursor: pointer;" 
                    onclick="openImageModal({{ $index }}, '{{ $seriesSlug }}')"
                    data-image-index="{{ $index }}"
                    data-image-src="{{ $galleryImage.image }}"
                    data-title-en="{{ $titleEn }}"
                    data-title-de="{{ $titleDe }}"
                    data-medium-en="{{ $mediumEn }}"
                    data-medium-de="{{ $mediumDe }}"
                    data-dimensions="{{ $dimensions }}"
                    data-year="{{ $year }}"
                    data-series-slug="{{ $seriesSlug }}"
                    data-series-title="{{ .Title }}"
                  />
              </div>
            {{ end }}
            {{/* Get title in current language - check current language image first, then fallback image */}}
            {{ $title := "" }}
            {{ if eq $currentLang "de" }}
              {{ $title = $currentLangImage.title_de | default $currentLangImage.title_en | default $galleryImage.title_de | default $galleryImage.title_en | default "" }}
            {{ else }}
              {{ $title = $currentLangImage.title_en | default $currentLangImage.title_de | default $galleryImage.title_en | default $galleryImage.title_de | default "" }}
            {{ end }}
            {{/* Fallback to old format for backward compatibility */}}
            {{ if not $title }}
              {{ if reflect.IsMap $currentLangImage.title }}
                {{ $title = index $currentLangImage.title $currentLang | default (index $currentLangImage.title "en") | default "" }}
              {{ else if reflect.IsMap $galleryImage.title }}
                {{ $title = index $galleryImage.title $currentLang | default (index $galleryImage.title "en") | default "" }}
              {{ else }}
                {{ $title = $currentLangImage.title | default $galleryImage.title | default "" }}
              {{ end }}
            {{ end }}
            {{ if $title }}
              <div class="f6 f5-ns fw4 black-90 mb1" style="font-family: 'Inter', sans-serif;">
                {{ $title | upper }}
              </div>
            {{ end }}
            {{/* Get medium in current language - check current language image first, then fallback image */}}
            {{ $medium := "" }}
            {{ if eq $currentLang "de" }}
              {{ $medium = $currentLangImage.medium_de | default $currentLangImage.medium_en | default $galleryImage.medium_de | default $galleryImage.medium_en | default "" }}
            {{ else }}
              {{ $medium = $currentLangImage.medium_en | default $currentLangImage.medium_de | default $galleryImage.medium_en | default $galleryImage.medium_de | default "" }}
            {{ end }}
            {{/* Fallback to old format for backward compatibility */}}
            {{ if not $medium }}
              {{ if reflect.IsMap $currentLangImage.medium }}
                {{ $medium = index $currentLangImage.medium $currentLang | default (index $currentLangImage.medium "en") | default "" }}
              {{ else if reflect.IsMap $galleryImage.medium }}
                {{ $medium = index $galleryImage.medium $currentLang | default (index $galleryImage.medium "en") | default "" }}
              {{ else }}
                {{ $medium = $currentLangImage.medium | default $galleryImage.medium | default "" }}
              {{ end }}
            {{ end }}
            {{ if $medium }}
              {{ $mediumFormatted := strings.FirstUpper $medium }}
              <div class="f6 black-70 mb1" style="font-family: 'Inter', sans-serif;">
                {{ $mediumFormatted }}
              </div>
            {{ end }}
            {{ $dimensions := $currentLangImage.dimensions | default $galleryImage.dimensions }}
            {{ if $dimensions }}
              <div class="f6 black-70 mb1" style="font-family: 'Inter', sans-serif;">
                {{ $dimensions }}
              </div>
            {{ end }}
            {{ $year := $currentLangImage.year | default $galleryImage.year }}
            {{ if $year }}
              <div class="f6 black-70" style="font-family: 'Inter', sans-serif;">
                {{ $year }}
              </div>
            {{ end }}
          </div>
        {{ end }}
      </div>
    {{ else }}
      {{/* Fallback: Show artworks from this series if no gallery images */}}
      {{ $seriesSlug := .Params.series_slug }}
      {{ $artworks := where .Site.RegularPages "Section" "artworks" }}
      {{ $seriesArtworks := slice }}
      {{ range $artworks }}
        {{ $artwork := . }}
        {{ if .Params.series }}
          {{ if reflect.IsSlice .Params.series }}
            {{ range .Params.series }}
              {{ if eq . $seriesSlug }}
                {{ $seriesArtworks = $seriesArtworks | append $artwork }}
              {{ end }}
            {{ end }}
          {{ else }}
            {{ if eq .Params.series $seriesSlug }}
              {{ $seriesArtworks = $seriesArtworks | append . }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
      
      {{ if $seriesArtworks }}
        <div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem 3rem; margin-bottom: 4rem;">
          {{ range $seriesArtworks }}
            <div class="gallery-item">
              {{ if .Params.image }}
                <div class="mb3" style="width: 100%;">
                  <a href="{{ .RelPermalink }}" class="db no-underline">
                    <img src="{{ .Params.image }}" alt="{{ .Title }}" class="w-100" style="max-width: 100%; height: auto; display: block;" />
                  </a>
                </div>
              {{ end }}
              <div class="f6 f5-ns fw4 black-90 mb1" style="font-family: 'Inter', sans-serif;">
                <a href="{{ .RelPermalink }}" class="black-90 hover-black no-underline">
                  {{ .Title }}
                </a>
              </div>
              {{ if or .Params.medium .Params.dimensions }}
                <div class="f6 black-70" style="font-family: 'Inter', sans-serif;">
                  {{ if .Params.medium }}{{ .Params.medium }}{{ end }}{{ if and .Params.medium .Params.dimensions }}, {{ end }}{{ if .Params.dimensions }}{{ .Params.dimensions }}{{ end }}
                </div>
              {{ end }}
            </div>
          {{ end }}
        </div>
      {{ end }}
    {{ end }}
    <div class="pb6"></div>
  </main>
</div>

<style>
  /* Hover underline for navigation links */
  .series-nav-link:hover {
    text-decoration: underline !important;
  }
  
  @media (max-width: 60em) {
    .series-nav {
      margin-bottom: 2rem;
    }
    .series-nav ul {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .series-nav li {
      margin-bottom: 0;
    }
    
    .gallery-grid {
      grid-template-columns: 1fr !important;
    }
  }
</style>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; z-index: 9999; overflow-y: auto;">
  <div class="image-modal-content" style="max-width: 90vw; max-height: 90vh; margin: 2rem auto; position: relative; padding: 2rem 0; padding-bottom: 6rem;">
    <button class="image-modal-close" onclick="closeImageModal()" style="position: fixed; top: 1rem; right: 1rem; background: black; border: none; color: white; font-size: 1.5rem; width: 2.5rem; height: 2.5rem; cursor: pointer; border-radius: 50%; z-index: 10001; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0; margin: 0;">✕</button>
    <button class="image-modal-prev image-modal-prev-side" onclick="navigateImage(-1)" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: black; border: none; color: white; font-size: 2rem; width: 3rem; height: 3rem; cursor: pointer; border-radius: 50%; z-index: 10000; display: none; align-items: center; justify-content: center; line-height: 1; padding: 0; margin: 0; text-align: center; vertical-align: middle;">‹</button>
    <button class="image-modal-next image-modal-next-side" onclick="navigateImage(1)" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: black; border: none; color: white; font-size: 2rem; width: 3rem; height: 3rem; cursor: pointer; border-radius: 50%; z-index: 10000; display: none; align-items: center; justify-content: center; line-height: 1; padding: 0; margin: 0; text-align: center; vertical-align: middle;">›</button>
    <div style="max-width: 100%; margin: 0 auto;">
      <img id="modalImage" src="" alt="" style="max-width: 100%; max-height: 80vh; display: block; margin: 0 auto;" />
      <div class="image-modal-info" style="padding: 2rem 0; margin-top: 1rem; text-align: left;">
      <div id="modalSeries" class="f7 f6-ns black-50 mb2" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em; text-transform: uppercase;"></div>
      <h2 id="modalTitle" class="f4 f3-ns fw6 mb3 black-90" style="font-family: 'Inter', sans-serif; letter-spacing: 0.05em;"></h2>
      <div id="modalMedium" class="f6 f5-ns black-70 mb2" style="font-family: 'Inter', sans-serif;"></div>
      <div id="modalDimensions" class="f6 f5-ns black-70 mb2" style="font-family: 'Inter', sans-serif;"></div>
      <div id="modalYear" class="f6 f5-ns black-70" style="font-family: 'Inter', sans-serif;"></div>
      </div>
    </div>
  </div>
  <!-- Mobile Bottom Navigation -->
  <div class="image-modal-nav-mobile" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e5e5; z-index: 10001; padding: 1rem; gap: 0.5rem;">
    <button class="image-modal-prev-mobile" onclick="navigateImage(-1)" style="flex: 1; background: black; border: none; color: white; font-size: 1rem; font-weight: 600; padding: 1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; font-family: 'Inter', sans-serif; display: none;">PREV</button>
    <button class="image-modal-next-mobile" onclick="navigateImage(1)" style="flex: 1; background: black; border: none; color: white; font-size: 1rem; font-weight: 600; padding: 1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; font-family: 'Inter', sans-serif; display: none;">NEXT</button>
  </div>
</div>

<style>
  @media (max-width: 30em) {
    .image-modal-info {
      padding-left: 1rem !important;
      padding-right: 1rem !important;
      padding-bottom: 8rem !important;
    }
    .image-modal-prev-side,
    .image-modal-next-side {
      display: none !important;
    }
    .image-modal-nav-mobile {
      display: flex !important;
    }
    .image-modal-content {
      padding-bottom: 10rem !important;
    }
  }
  @media (min-width: 30.01em) {
    .image-modal-nav-mobile {
      display: none !important;
    }
  }
</style>

<script>
let currentImageIndex = 0;
let allImages = [];
let currentSeriesSlug = '';

// Collect all images on page load
document.addEventListener('DOMContentLoaded', function() {
  const images = document.querySelectorAll('.gallery-image-clickable');
  allImages = Array.from(images).map(img => ({
    src: img.dataset.imageSrc,
    titleEn: img.dataset.titleEn || '',
    titleDe: img.dataset.titleDe || '',
    mediumEn: img.dataset.mediumEn || '',
    mediumDe: img.dataset.mediumDe || '',
    dimensions: img.dataset.dimensions || '',
    year: img.dataset.year || '',
    seriesSlug: img.dataset.seriesSlug || '',
    seriesTitle: img.dataset.seriesTitle || ''
  }));
  
  // Show/hide navigation arrows based on number of images
  if (allImages.length > 1) {
    const prevBtn = document.querySelector('.image-modal-prev-side');
    const nextBtn = document.querySelector('.image-modal-next-side');
    const prevBtnMobile = document.querySelector('.image-modal-prev-mobile');
    const nextBtnMobile = document.querySelector('.image-modal-next-mobile');
    if (prevBtn) prevBtn.style.display = 'flex';
    if (nextBtn) nextBtn.style.display = 'flex';
    if (prevBtnMobile) prevBtnMobile.style.display = 'block';
    if (nextBtnMobile) nextBtnMobile.style.display = 'block';
  }
  
  // Add keyboard navigation
  document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('imageModal');
    if (modal && modal.style.display !== 'none') {
      if (e.key === 'Escape') {
        closeImageModal();
      } else if (e.key === 'ArrowLeft') {
        navigateImage(-1);
      } else if (e.key === 'ArrowRight') {
        navigateImage(1);
      }
    }
  });
  
  // Close modal when clicking outside image
  const modal = document.getElementById('imageModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeImageModal();
      }
    });
  }
});

function openImageModal(index, seriesSlug) {
  currentImageIndex = parseInt(index);
  currentSeriesSlug = seriesSlug;
  const image = allImages[currentImageIndex];
  if (!image) return;
  
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const modalSeries = document.getElementById('modalSeries');
  const modalTitle = document.getElementById('modalTitle');
  const modalMedium = document.getElementById('modalMedium');
  const modalDimensions = document.getElementById('modalDimensions');
  const modalYear = document.getElementById('modalYear');
  
  // Get current language
  const currentLang = document.documentElement.lang || 'en';
  const isDe = currentLang === 'de' || window.location.pathname.startsWith('/de/');
  
  modalImage.src = image.src;
  modalImage.alt = isDe ? (image.titleDe || image.titleEn) : (image.titleEn || image.titleDe);
  modalSeries.textContent = image.seriesTitle ? image.seriesTitle.toUpperCase() : '';
  modalSeries.style.display = image.seriesTitle ? 'block' : 'none';
  modalTitle.textContent = (isDe ? (image.titleDe || image.titleEn) : (image.titleEn || image.titleDe)).toUpperCase();
  
  const medium = isDe ? (image.mediumDe || image.mediumEn) : (image.mediumEn || image.mediumDe);
  modalMedium.textContent = medium ? medium.charAt(0).toUpperCase() + medium.slice(1) : '';
  modalMedium.style.display = medium ? 'block' : 'none';
  
  modalDimensions.textContent = image.dimensions || '';
  modalDimensions.style.display = image.dimensions ? 'block' : 'none';
  
  modalYear.textContent = image.year || '';
  modalYear.style.display = image.year ? 'block' : 'none';
  
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden'; // Prevent background scrolling
  
  // Navigation buttons are always visible when there are multiple images (looping enabled)
}

function closeImageModal() {
  const modal = document.getElementById('imageModal');
  modal.style.display = 'none';
  document.body.style.overflow = ''; // Restore scrolling
}

function navigateImage(direction) {
  let newIndex = currentImageIndex + direction;
  // Loop around: if going past the end, go to the beginning; if going before the start, go to the end
  if (newIndex < 0) {
    newIndex = allImages.length - 1;
  } else if (newIndex >= allImages.length) {
    newIndex = 0;
  }
  openImageModal(newIndex, currentSeriesSlug);
}
</script>
{{ end }}

